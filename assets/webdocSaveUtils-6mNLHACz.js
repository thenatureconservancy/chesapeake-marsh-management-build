const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/geometryServiceUtils-CW3vKbWo.js","assets/index-v3vBpdnQ.js","assets/index-DMZxIv6O.css"])))=>i.map(i=>d[i]);
import{N as L,fB as B,j as y,R as d,fC as K,bK as F,a7 as H,a5 as U,c as i,E as m,i as c,fD as J,Y as z,fE as q,_ as Q,fF as Y,ap as X,fG as Z,S as f,fH as ee,u as ae,Q as I,fI as te,fJ as oe,fK as ne}from"./index-v3vBpdnQ.js";import{i as re}from"./originUtils-COMae9xO.js";import{p as $}from"./resourceUtils-DnRHHKYm.js";import{o as A,s as P,n as ie}from"./saveUtils-L3pcNMVI.js";import"./resourceUtils-CG0zhWYq.js";const se=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map(a=>a.toLowerCase());async function xe(a,e,t){t??={},le(a,e),await y(()=>!e.updatingFromView),await e.load(),await C(e),await A(e),await O(a,e);const o=e.portalItem,{json:n,jsonContext:r}=await S(e,o,a.origin);return P(r,{errorName:`${a.name}:save`},t),await E(e,o),await Ce(a,e,o,n,r),await Promise.all([e.updateItemThumbnail(),$(e.resourceReferences,r)]),o}async function S(a,e,t){const o=L(e,t,!0),n=a.write({},o);return await Promise.all(o.resources.pendingOperations),{json:n,jsonContext:o}}async function Le(a,e,t,o){o??={};const n=ce(a,t);await y(()=>!e.updatingFromView),await e.load(),await C(e),await A(e),await O(a,e);const{json:r,jsonContext:s}=await S(e,n,a.origin);P(s,{errorName:`${a.name}:save`},o),await de(e,n);const l=e.getThumbnailState();return await Ee(a,e,n,r,s,o)&&(e.resourceReferences.portalItem=n),e.restoreThumbnailFromState(l),await Promise.all([e.updateItemThumbnail(),$(e.resourceReferences,s)]),n}function le(a,e){if(!e.portalItem)throw new d(`${a.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");T(a,e.portalItem)}function T(a,e){if(e.type!==a.itemType)throw new d(`${a.name}:portal-item-wrong-type`,`Portal item needs to have type "${a.itemType}"`)}async function O(a,e){if(a.name==="linkchart")return;if(!e.basemap?.baseLayers.length)throw new d(`${a.name}:save`,"Map does not have a valid basemap with a base layer.");let t=null;if(await y(()=>{const o=K(e.initialViewProperties,e.basemap);return t=o.spatialReference,!o.updating}),!F(t,e.initialViewProperties.spatialReference))throw new d(`${a.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",{expected:e.initialViewProperties.spatialReference,actual:t})}function ce(a,e){let t=H.from(e);return t.id&&(t=t.clone(),t.id=null),t.type||(t.type=a.itemType),t.portal||(t.portal=U.getDefault()),T(a,t),t}function C(a){const e=[];return a.basemap&&e.push(a.basemap.load()),a.ground&&e.push(a.ground.load()),Promise.allSettled(e).then(()=>{})}async function E(a,e){e.extent=await Ie(a.portalItem,a.initialViewProperties.viewpoint.targetGeometry),await me(a,e)}const pe=m.JSAPI,D="CollectorDisabled",_="Collector",g="Data Editing",k="OfflineDisabled",b="Offline",V="Workforce Project",M="Workforce Worker",G="Workforce Dispatcher",ue="Offline Map Areas",fe="FieldMapsDisabled",R=m.DEVELOPER_BASEMAP,v="UtilityNetwork",W="IPS";async function de(a,e){i(e,D),i(e,fe),i(e,m.METADATA),i(e,k),i(e,ue),i(e,G),i(e,V),i(e,M),await E(a,e)}async function me(a,e){c(e,pe),await we(a),he(a,e),_e(a,e),ge(a,e),be(a,e),Re(a,e),ve(a,e),We(a,e),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((t,o,n)=>n.indexOf(t)===o))}function we(a){const e=h(a).map(t=>t.load()).toArray();return Promise.allSettled(e).then(()=>{})}function h(a){return a.allLayers.concat(a.allTables)}function N(a){return h(a).some(e=>e.loaded&&I(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled&&(e.type!=="subtype-group"||e.sublayers.some(t=>t.editingEnabled)))}function ye(a){return h(a).filter(e=>e.type!=="group").every(e=>e.loaded&&Pe(a,e))}function he(a,e){f(e,D)||f(e,V)||f(e,M)||f(e,G)||!N(a)?i(e,_):c(e,_)}function _e(a,e){N(a)?c(e,g):i(e,g)}function ge(a,e){!f(e,k)&&ye(a)?c(e,b):i(e,b)}function be(a,e){ee(a.basemap)?c(e,R):i(e,R)}function Re(a,e){a.utilityNetworks?.length?c(e,v):i(e,v)}function ve(a,e){a.ipsInfo?c(e,W):i(e,W)}function We(a,e){ae(e,m.CHARTS,ie(a))}async function Ie(a,e){const t=e.clone().normalize();let o;if(t.length>1)for(const n of t)o?n.width>o.width&&(o=n):o=n;else o=t[0];return $e(a,o)}async function $e(a,e){const t=e.spatialReference;if(t.isWGS84)return e.clone();if(t.isWebMercator)return q(e);const{getGeometryServiceURL:o}=await Q(()=>import("./geometryServiceUtils-CW3vKbWo.js"),__vite__mapDeps([0,1,2])),n=await o(a),r=new Y({geometries:[e],outSpatialReference:X.WGS84});return(await Z(n,r))[0]}function Ae(a){return te(a)||a.type==="map-notes"||a.type==="route"}function Pe(a,e){return I(e)&&e.capabilities.operations.supportsSync||Ae(e)&&!e.portalItem||Se(e)&&!Te(e)&&e.spatialReference.equals(a.initialViewProperties.spatialReference)}function Se(a){return(a.type==="tile"||a.type==="vector-tile")&&(a.capabilities.operations.supportsExportTiles||Oe(a)||oe(a))}function Te(a){return a.type==="vector-tile"&&Object.keys(a.sourceNameToSource).length>1}function Oe(a){return a.type==="tile"&&ne(a.url)&&se.some(e=>a.url?.toLowerCase().includes("/"+e+"/"))}async function Ce(a,e,t,o,n){await t.update({data:o}),j(a,e,t,o,n)}async function Ee(a,e,t,o,n,r){const s=e.portalItem,l={item:s,authenticated:!(!s?.id||!s.portal.user)},p=t.portal;await p.signIn();const{copyAllowed:u,itemReloaded:w}=await De(l,p);if(l.authenticated||=w,!u)throw new d(`${a.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");const x=await ke(t,l,o,r);return e.portalItem=t,j(a,e,t,o,n),x}async function De(a,e){const{item:t,authenticated:o}=a;return t?.id&&t.typeKeywords?.includes("useOnly")?t.portal.portalHostname!==e.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(o||await t.reload(),{copyAllowed:t.itemControl==="admin"||t.itemControl==="update",itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}}async function ke(a,e,t,o){const n=a.portal,{item:r}=e,{folder:s,copyAllResources:l}=o;let p=!1;if(l&&r?.id&&B(r.portal.url,n.url)&&parseInt(r.portal.currentVersion,10)>=2023){const{total:u}=await r.fetchResources();p=!!u}if(p){const u=await r.copy({copyResources:"all",folder:s});a.id=u.id,a.portal=u.portal;const w=a.toJSON();await a.load(),a.read(w),await a.update({data:t})}else await n.user.addItem({item:a,folder:s,data:t});return p}function j(a,e,t,o,n){J.prototype.read.call(e,{version:o.version,authoringApp:o.authoringApp,authoringAppVersion:o.authoringAppVersion},{origin:a.origin,ignoreDefaults:!0,url:t.itemUrl?z(t.itemUrl):void 0}),re(n),e.resourceInfo=o}export{S as createJSON,ke as initializeNewItem,De as isCopyAllowed,xe as save,Le as saveAs};
