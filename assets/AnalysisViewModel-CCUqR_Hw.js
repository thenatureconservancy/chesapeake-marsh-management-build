import{b as d,f as c,a as w,d as p,w as y,e as h,U as V,g as r,h as u,j as g,s as A,k as O,m as f,n as _,r as i,o as n,p as I}from"./index-v3vBpdnQ.js";var o;(function(s){s[s.PENDING=0]="PENDING",s[s.WAIT_FOR_VIEW_READY=1]="WAIT_FOR_VIEW_READY",s[s.RUNNING=2]="RUNNING"})(o||(o={}));let t=class extends d{constructor(s={}){super(s),this.view=null,this.analysisView=null,this._reconnectViewTask=null,this._forceInteractiveHandle=null,this._changeFromReconnect=!1,this._startUserOperation=null;const e=s?.analysis;e!=null?this.analysis=e:(this._set("analysis",this.constructAnalysis()),this._set("isAnalysisOwner",!0)),s?.visible!=null&&(this.visible=s.visible)}normalizeCtorArgs(s){const{analysis:e,isDefaultViewModel:l,...a}=s;return a}initialize(){const s=()=>{this._changeFromReconnect||this._viewHasAnalysis||this._set("isAnalysisOwner",!1);const e=!this._changeFromReconnect;this._changeFromReconnect=!1,e&&this._scheduleViewReconnect()};this.addHandles([c(()=>this.view!=null&&this.view.ready&&!this.supported,()=>h.getLogger(this).errorOnce(this.unsupportedErrorMessage),y),w(()=>[this.analysis,this._viewHasAnalysis],s,V),p(()=>this.view,"analysis-view-destroy",e=>{e.analysis===this.analysis&&s()}),w(()=>({view:this.view,ready:this.view!=null&&this.view.ready,supported:this.supported}),({view:e},l)=>{const a=l?.view;e!==a&&(this._startUserOperation=r(this._startUserOperation),this._disconnectFromView(a)),this._scheduleViewReconnect()},y)])}destroy(){this._reconnectViewTask=r(this._reconnectViewTask),this._startUserOperation=r(this._startUserOperation),this.analysisView!=null&&(this.analysisView.visible=void 0),this._disconnectFromView(this.view),this._set("view",null),this.analysis!=null&&this.isAnalysisOwner&&(this.analysis.destroy(),this._set("analysis",null))}get supported(){return this.view==null||this.view.type===this.supportedViewType}set visible(s){this._set("visible",s),this.analysisView!=null&&(this.analysisView.visible=s)}get active(){return this.tool!=null&&this.tool.active}get disabled(){return this.view==null||!this.view.ready||!this.supported}set analysis(s){s!==this._get("analysis")&&(this._startUserOperation=r(this._startUserOperation),this._disconnectFromView(this.view),this._setExternalAnalysis(s),this._scheduleViewReconnect())}get ready(){return this.analysisView!=null&&!this.connectingToView}get connectingToView(){return this._reconnectViewTask!=null}get isAnalysisOwner(){return this._get("isAnalysisOwner")}get _viewHasAnalysis(){const{view:s}=this;return s!=null&&s.analyses.includes(this.analysis)}get tool(){return this.analysisView?.tool}clear(){this._startUserOperation=r(this._startUserOperation),this._resetInteractiveCreationState(),this.tool!=null&&this.view!=null&&this.view.activeTool===this.tool&&(this.view.activeTool=null)}async start(){if(!this.visible)return void h.getLogger(this).warn("Cannot start analysis when not visible");this.clear();const s={task:null,abort:null,state:o.PENDING},e=u(async l=>{if(s.state=o.WAIT_FOR_VIEW_READY,await g(()=>this.ready,l),s.state=o.RUNNING,this.analysisView==null||this.view==null)return;const a=this.analysisView.tool;a!=null&&(this.view.activeTool=a,c(()=>a.created,()=>{a.active&&this.view!=null&&(this.view.activeTool=null)},{initial:!0,once:!0}))});return s.task=e,s.abort=()=>e.abort(),this._startUserOperation=s,e.promise}onConnectToAnalysisView(s){}onDisconnectFromAnalysisView(){}_scheduleViewReconnect(){this._reconnectViewTask=r(this._reconnectViewTask);const s=u(async e=>{try{await this._reconnectView(e)}catch(l){if(A(e),!O(l))return void h.getLogger(this).warn("Failed to use analysis in view model",l);throw l}finally{s===this._reconnectViewTask&&(this._reconnectViewTask=null)}});this._reconnectViewTask=s}async _reconnectView(s){const{view:e}=this,l=e!=null&&e.ready&&this.supported,a=this.analysis;this._startUserOperation=v(this._startUserOperation),this._disconnectFromView(e),l&&e!=null&&a!=null&&(this.isAnalysisOwner&&(this._changeFromReconnect=!0,e.analyses.add(a)),this.analysisView=await e.whenAnalysisView(a),f(s)?this._startUserOperation=v(this._startUserOperation):(this.analysisView.visible=this.visible,this._forceInteractiveHandle=this.analysisView.forceInteractive(),this.addHandles(this._forceInteractiveHandle),this.onConnectToAnalysisView(this.analysisView)))}_disconnectFromView(s){s!=null&&this.isAnalysisOwner&&s.analyses.includes(this.analysis)&&(this._changeFromReconnect=!0,this.analysis.clear(),s.analyses.remove(this.analysis)),this.onDisconnectFromAnalysisView(),this._forceInteractiveHandle=_(this._forceInteractiveHandle),this.analysisView=null}_setExternalAnalysis(s){this.analysisView==null||this.isAnalysisOwner||(this.analysisView.visible=void 0,this._forceInteractiveHandle=_(this._forceInteractiveHandle)),this.analysisView=null,this._set("isAnalysisOwner",!1),this._set("analysis",s),this._changeFromReconnect=!1}_resetInteractiveCreationState(){this.analysis.clear(),this.tool?.resetCreated()}get testInfo(){}};function v(s){return s!=null&&s.state>=o.RUNNING?(s.abort(),null):s}i([n()],t.prototype,"supported",null),i([n()],t.prototype,"view",void 0),i([n({type:Boolean,value:!0})],t.prototype,"visible",null),i([n()],t.prototype,"active",null),i([n()],t.prototype,"disabled",null),i([n({nonNullable:!0})],t.prototype,"analysis",null),i([n()],t.prototype,"analysisView",void 0),i([n()],t.prototype,"ready",null),i([n()],t.prototype,"connectingToView",null),i([n({readOnly:!0})],t.prototype,"isAnalysisOwner",null),i([n()],t.prototype,"_viewHasAnalysis",null),i([n()],t.prototype,"_reconnectViewTask",void 0),i([n()],t.prototype,"_forceInteractiveHandle",void 0),i([n()],t.prototype,"tool",null),t=i([I("esri.widgets.support.AnalysisViewModel")],t);export{t as V};
