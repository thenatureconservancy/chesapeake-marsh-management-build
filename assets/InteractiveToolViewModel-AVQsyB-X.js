const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/DrawTool-DorrJd-Y.js","assets/index-v3vBpdnQ.js","assets/index-DMZxIv6O.css","assets/drawSurfaces-CaBTK7bh.js","assets/memoize-DmxaQ-k8.js","assets/ReactiveSet-DlScxYoM.js","assets/SnappingDragPipelineStep-cw-qmV7t.js","assets/quat-CzjAuFtU.js","assets/hydratedFeatures-Cq6vhkEz.js","assets/meshVertexSpaceUtils-CBUTOjIq.js","assets/MeshLocalVertexSpace-C2gIorG0.js","assets/SnappingContext-mEkajMTm.js"])))=>i.map(i=>d[i]);
import{dZ as z,d_ as F,lf as C,hF as N,e0 as K,aR as B,iE as E,aQ as Y,jE as j,r,o as a,p as g,hU as s,mr as h,ot as d,am as T,_ as b,rf as S,b as k,a as Q,w as q,f as J,e as W}from"./index-v3vBpdnQ.js";import{d as X}from"./SnappingVisualizer2D-DLasb_Hx.js";import{P as ee,E as G,p as M,e as te,a as R}from"./SnappingContext-mEkajMTm.js";import{b as ie,e as Z,d as $,F as oe}from"./SnappingDragPipelineStep-cw-qmV7t.js";var A,y;let l=(y=class extends z.EsriPromiseMixin(F.EventedAccessor){constructor(e){super(e),this._hasZ=null,this._cursorScreenPoint=null,this._activePointerId=null,this._stagedVertexUnsnapped=null,this._lastVertexUnsnapped=null,this.interactiveUndoDisabled=!1,this.history=[],this.redoHistory=[],this.snapToScene=!1,this.view=null,this.elevationInfo=null,this.defaultZ=0,this._coordinateHelper=ee(!!e.hasZ,!1,e.view.spatialReference),this._snappingManager=e.snappingManager,this._editGeometryOperations=new G(new M(e.editGeometryType??"polygon",this._coordinateHelper),C.Local),this._snappingGraphicsLayer=new N({id:A.SNAPPING_GRAPHICS_LAYER_ID,listMode:"hide",internal:!0}),this._snappingContext=new te({editGeometryOperations:this._editGeometryOperations,elevationInfo:{mode:"on-the-ground",offset:0},pointer:"mouse",visualizer:new X(this._snappingGraphicsLayer)}),this._activeComponent=new R(e.view.spatialReference,C.Local),this._editGeometryOperations.data.components.push(this._activeComponent)}normalizeCtorArgs(e){const i={...e};return delete i.editGeometryType,delete i.snappingManager,i}initialize(){this._snappingOperation=new ie({view:this.view}),this.view.type==="2d"&&this.view.map.layers.add(this._snappingGraphicsLayer)}destroy(){this.view.map.layers.remove(this._snappingGraphicsLayer),this._snappingGraphicsLayer.destroy(),this._snappingManager!=null&&this._snappingManager.doneSnapping(),this._snappingOperation=K(this._snappingOperation),this._editGeometryOperations.destroy()}get _committedVertices(){return this._editGeometryOperations.data.components[0].vertices.map(e=>e.pos)}get vertices(){return this._stagedVertex!=null?[...this._committedVertices,this._coordinateHelper.pointToArray(this._stagedVertex)]:this._committedVertices}get hasZ(){return this._hasZ!=null?this._hasZ:this.view.type==="3d"}set hasZ(e){this._hasZ=e,this.notifyChange("hasZ")}get _stagedVertex(){return this._snappingOperation?.stagedPoint}set _stagedVertex(e){this._snappingOperation&&(this._snappingOperation.stagedPoint=B(e))}canUndo(){return this._editGeometryOperations.canUndo}canRedo(){return this._editGeometryOperations.canRedo}undo(){this.canUndo&&this._editGeometryOperations.undo()}redo(){this.canRedo&&this._editGeometryOperations.redo()}getCoordsFromScreenPoint(e){const i=e&&this.screenToMap(e);return i==null?null:i.hasZ?[i.x,i.y,i.z]:[i.x,i.y]}getCoordsAndPointFromScreenPoint(e){const i=this.screenToMap(e);return i==null?null:i.hasZ?{vertex:[i.x,i.y,i.z],mapPoint:i}:{vertex:[i.x,i.y],mapPoint:i}}screenToMap(e){let i=null;if(this.view.type==="3d")if(this.hasZ){const o=this.elevationInfo??se;i=this.view.sceneIntersectionHelper.intersectElevationFromScreen(E(e.x,e.y),o,this._getGeometryZValue())}else{const o=this.elevationInfo??re;i=this.view.sceneIntersectionHelper.intersectElevationFromScreen(E(e.x,e.y),o,0),i!=null&&(i.z=void 0)}else i=this.view.toMap(e),i!=null&&(i.z=this.hasZ?this._getGeometryZValue():void 0);return i}_pushCursorVertex(e,i){const o=Y(e[0],e[1],void 0,this.view.spatialReference);this._stagedVertexUnsnapped=o;const n=this._snappingManager;if(n==null)return this._stagedVertex=o,void i();j(this._snappingOperation.snap({point:o},n,this._snappingContext)).then(()=>{i()})}_popCursorVertex(){this._stagedVertexUnsnapped=null,this._stagedVertex=null}_getGeometryZValue(){return this.defaultZ}_abortSnapping(){this._snappingOperation.abort()}_isDuplicateOfLastVertex(e){const i=this._editGeometryOperations.data.components[0].getLastVertex()?.pos;if(i&&e[0]===i[0]&&e[1]===i[1])return!0;const{x:o,y:n}=this._coordinateHelper.vectorToDehydratedPoint(e);return this._lastVertexUnsnapped!=null&&o===this._lastVertexUnsnapped.x&&n===this._lastVertexUnsnapped.y}_shouldHandlePointerEvent(e){return ne(e)&&(this._activePointerId==null||this._activePointerId===e.pointerId)}_vertexAddHandler(e){const i=this._stagedVertex!=null?this._coordinateHelper.pointToArray(this._stagedVertex):this.getCoordsFromScreenPoint(this._cursorScreenPoint);i!=null&&this._addVertex(i,e.native)}_drawCompleteHandler(e){this._completeDrawing(e.native)}},A=y,y.SNAPPING_GRAPHICS_LAYER_ID="DrawAction-snapping-graphics-layer",y);r([a({readOnly:!0})],l.prototype,"vertices",null),r([a({type:Boolean,nonNullable:!0})],l.prototype,"interactiveUndoDisabled",void 0),r([a({readOnly:!0})],l.prototype,"history",void 0),r([a({readOnly:!0})],l.prototype,"redoHistory",void 0),r([a()],l.prototype,"snapToScene",void 0),r([a()],l.prototype,"view",void 0),r([a()],l.prototype,"elevationInfo",void 0),r([a({nonNullable:!0})],l.prototype,"defaultZ",void 0),r([a()],l.prototype,"hasZ",null),r([a()],l.prototype,"_snappingOperation",void 0),r([a()],l.prototype,"_stagedVertex",null),l=A=r([g("esri.views.draw.DrawAction")],l);const se={mode:"absolute-height",offset:0},re={mode:"on-the-ground",offset:0};function ne(t){return t.pointerType!=="mouse"||t.button===0}const f=l;class p{constructor(e,i,o){this.view=e,this.vertexIndex=i,this.vertices=o,this.defaultPrevented=!1,this.type="vertex-add"}preventDefault(){this.defaultPrevented=!0}}class m{constructor(e,i,o){this.view=e,this.vertexIndex=i,this.vertices=o,this.defaultPrevented=!1,this.type="vertex-remove"}preventDefault(){this.defaultPrevented=!0}}class v{constructor(e,i,o,n=null){this.view=e,this.vertexIndex=i,this.vertices=o,this.mapPoint=n,this.coordinates=null,this.defaultPrevented=!1,this.type="cursor-update",this.coordinates=o.length===1?o[0]:null}preventDefault(){this.defaultPrevented=!0}}class u{constructor(e){this.vertices=e,this.coordinates=null,this.defaultPrevented=!1,this.type="draw-complete",this.coordinates=e.length===1?e[0]:null}preventDefault(){this.defaultPrevented=!0}}const I=Symbol("view-handles"),U=Symbol("undo-redo-handles");let D=class extends f{constructor(t){super(t),this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1}initialize(){this._addViewHandles(),this._addUndoRedoHandles()}destroy(){this._removeViewHandles(),this._removeUndoRedoHandles(),this.emit("destroy")}undo(){super.undo(),this.notifyChange("vertices")}redo(){super.redo(),this.notifyChange("vertices")}complete(){this._completeDrawing()}_addViewHandles(){this._removeViewHandles(),this.addHandles([this.view.on("click",t=>{t.stopPropagation()},s.TOOL),this.view.on("pointer-down",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._activePointerId=t.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=h(t),t.pointerType==="touch"&&this._updateCursor())},s.TOOL),this.view.on("pointer-move",t=>{this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._abortSnapping(),this._cursorScreenPoint=h(t),t.pointerType!=="touch"&&this._updateCursor()},s.TOOL),this.view.on("pointer-drag",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._addVertexOnPointerUp=!1)},s.TOOL),this.view.on("pointer-up",t=>{if(this._shouldHandlePointerEvent(t))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp)this._vertexAddHandler(t);else{const e=t.pointerType==="touch";this._updateCursor(e)}},s.TOOL),this.view.on("drag",["Shift"],t=>{t.stopPropagation()},s.TOOL),this.view.on("double-click",t=>{t.stopPropagation(),this._drawCompleteHandler(t)},s.TOOL),this.view.on("double-click",["Control"],t=>{t.stopPropagation(),this._drawCompleteHandler(t)},s.TOOL),this.view.on("key-down",t=>{const{key:e,repeat:i}=t;e===d.vertexAdd&&!i&&this._cursorScreenPoint?(t.stopPropagation(),this._abortSnapping(),this._vertexAddHandler(t)):e!==d.complete||i?e!==d.undo||this.interactiveUndoDisabled||i?e!==d.redo||this.interactiveUndoDisabled||i?e!==d.pan||i||t.stopPropagation():(t.stopPropagation(),this.redo()):(t.stopPropagation(),this.undo()):(t.stopPropagation(),this._drawCompleteHandler(t))},s.TOOL),this.view.on("key-up",t=>{t.key===d.pan&&t.stopPropagation()},s.TOOL)],I)}_addUndoRedoHandles(){this._removeUndoRedoHandles(),this.addHandles([this._editGeometryOperations.on("vertex-remove",t=>{if(this.notifyChange("vertices"),t.operation==="undo"){const e=[...this._committedVertices];this._stagedVertex!=null&&e.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new m(this.view,t.vertices[0].index,e))}}),this._editGeometryOperations.on("vertex-add",t=>{if(this.notifyChange("vertices"),t.operation==="apply"){const e=this._committedVertices.length-1,i=new p(this.view,e,this.vertices);this.emit("vertex-add",i),i.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(t.operation==="redo"){const e=[...this._committedVertices];this._stagedVertex!=null&&e.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new p(this.view,t.vertices[0].index,e))}})],U)}_removeViewHandles(){this.removeHandles(I)}_removeUndoRedoHandles(){this.removeHandles(U)}_addVertex(t){const e=this._coordinateHelper.arrayToVector(t);this._isDuplicateOfLastVertex(e)||this._editGeometryOperations.appendVertex(e)}_updateCursor(t=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const e=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);e==null||t||this._pushCursorVertex(e.vertex,()=>this.emit("cursor-update",new v(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new T(this._stagedVertex):null)))}_completeDrawing(){if(this._activePointerId=null,this._popCursorVertex(),this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping(),this.vertices.length<1)return;const t=new u(this.vertices);this.emit("draw-complete",t),t.defaultPrevented||this._removeViewHandles()}};D=r([g("esri.views.draw.MultipointDrawAction")],D);const ae=D;let L=class extends f{constructor(e){super(e),this._addVertexOnPointerUp=!1,this._drawTool=null}initialize(){this._addViewHandles(),this.view.type==="3d"&&this.addResolvingPromise(this._addDrawTool())}destroy(){this._removeDrawTool(),this.emit("destroy")}complete(){this._completeDrawing()}_addViewHandles(){this._addViewHandles2DOnly(),this.addHandles([this.view.on("key-down",e=>{e.key===d.complete&&(this._drawTool?this.complete():(this._abortSnapping(),this._vertexAddHandler(e)))},s.TOOL)])}_addViewHandles2DOnly(){this.view.type==="2d"&&this.addHandles([this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=h(e),e.pointerType==="touch"&&this._updateCursor())},s.TOOL),this.view.on("pointer-move",e=>{this._abortSnapping(),this._cursorScreenPoint=h(e),e.pointerType!=="touch"&&this._updateCursor()},s.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._addVertexOnPointerUp=!1)},s.TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp)e.stopPropagation(),this._vertexAddHandler(e);else{const i=e.pointerType==="touch";this._updateCursor(i)}},s.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},s.TOOL)])}async _addDrawTool(){const[{DrawTool:e},i]=await Promise.all([b(()=>import("./DrawTool-DorrJd-Y.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11])),S()]),o=new e({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"point",mode:"click",automaticLengthMeasurementUtils:i});this.destroyed?o.destroy():(this._drawTool=o,this.view.addAndActivateTool(o),this.addHandles([o.on("cursor-update",n=>{n.vertices.length===1&&this.emit("cursor-update",new v(this.view,n.vertices[0].vertexIndex,o.getVertexCoords()))}),o.on("complete",n=>{this.emit("draw-complete",new u(o.getVertexCoords())),this._removeDrawTool(),this.removeAllHandles()})]))}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(e){const i=this._coordinateHelper.arrayToVector(e);this._isDuplicateOfLastVertex(i)||(this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(i),this.notifyChange("vertices"),this._completeDrawing())}_updateCursor(e=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const i=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);i==null||e||this._pushCursorVertex(i.vertex,()=>this.emit("cursor-update",new v(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new T(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return void this._drawTool.completeCreateOperation();this._activePointerId=null,this._popCursorVertex(),this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping();const e=new u(this.vertices);this.emit("draw-complete",e),e.defaultPrevented||this.removeAllHandles()}};L=r([g("esri.views.draw.PointDrawAction")],L);const de=L;let x=class extends f{constructor(e){super(e),this._panEnabled=!1,this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1,this._drawTool=null,this.mode=Z}initialize(){this._addViewHandles(),this.view.type==="3d"&&this.addResolvingPromise(this._addDrawTool())}destroy(){this._removeDrawTool(),this.emit("destroy")}get _dragEnabled(){return this.mode==="freehand"||this.mode==="hybrid"}get _clickEnabled(){return this.mode==="click"||this.mode==="hybrid"}undo(){this._drawTool?this._drawTool.undo():(super.undo(),this.notifyChange("vertices"))}redo(){this._drawTool?this._drawTool.redo():(super.redo(),this.notifyChange("vertices"))}canUndo(){return this._drawTool?.canUndo()??super.canUndo()}canRedo(){return this._drawTool?.canRedo()??super.canRedo()}complete(){this._completeDrawing()}_getGeometryZValue(){return this.hasZ&&this.vertices.length>0?this.vertices[0][2]:this.defaultZ}_addViewHandles(){this._addViewHandles2DOnly(),this.addHandles(this.view.on("key-down",e=>{const{key:i,repeat:o}=e;i!==d.vertexAdd||o?i!==d.complete||o?i!==d.undo||this.interactiveUndoDisabled||o?i!==d.redo||this.interactiveUndoDisabled||o||(e.stopPropagation(),this.redo()):(e.stopPropagation(),this.undo()):(e.stopPropagation(),this._drawCompleteHandler(e)):(e.stopPropagation(),this._handleVertexAddKey(e))},s.TOOL))}_addViewHandles2DOnly(){this.view.type==="2d"&&(this.addHandles([this.view.on("click",e=>{e.stopPropagation()},s.TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=h(e),e.pointerType==="touch"&&this._updateCursor())},s.TOOL),this.view.on("pointer-move",e=>{this._abortSnapping(),this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._cursorScreenPoint=h(e),e.pointerType!=="touch"&&this._updateCursor()},s.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._cursorScreenPoint=h(e),this._dragEnabled&&!this._panEnabled?this._vertexAddHandler(e):this._addVertexOnPointerUp=!1)},s.TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp){if(!this._clickEnabled)return this.vertices.length===1&&this.vertices.pop(),void this._drawCompleteHandler(e);this._vertexAddHandler(e)}else{const i=e.pointerType==="touch";this._updateCursor(i)}},s.TOOL),this.view.on("drag",e=>{this._dragEnabled&&this._activePointerId!=null&&!this._panEnabled&&e.stopPropagation()},s.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},s.TOOL),this.view.on("double-click",e=>{e.stopPropagation(),this._drawCompleteHandler(e)},s.TOOL),this.view.on("double-click",["Control"],e=>{e.stopPropagation(),this._drawCompleteHandler(e)},s.TOOL),this.view.on("key-down",e=>{const{key:i,repeat:o}=e;i!==d.pan||o||(e.stopPropagation(),this._panEnabled=!0)},s.TOOL),this.view.on("key-up",e=>{e.key===d.pan&&(e.stopPropagation(),this._panEnabled=!1)},s.TOOL)]),this._addUndoRedoHandles())}_handleVertexAddKey(e){this._drawTool?this._drawTool.drawOperation.commitStagedVertex():this._cursorScreenPoint&&(this._abortSnapping(),this._vertexAddHandler(e))}_addUndoRedoHandles(){this.addHandles([this._editGeometryOperations.on("vertex-remove",e=>{if(this.notifyChange("vertices"),e.operation==="undo"){const i=[...this._committedVertices];this._stagedVertex!=null&&i.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new m(this.view,e.vertices[0].index,i))}}),this._editGeometryOperations.on("vertex-add",e=>{if(this.notifyChange("vertices"),e.operation==="apply"){const i=this._committedVertices.length-1,o=new p(this.view,i,this.vertices);this.emit("vertex-add",o),o.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(e.operation==="redo"){const i=[...this._committedVertices];this._stagedVertex!=null&&i.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new p(this.view,e.vertices[0].index,i))}})])}async _addDrawTool(){const[{DrawTool:e},i]=await Promise.all([b(()=>import("./DrawTool-DorrJd-Y.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11])),S()]),o=new e({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"polygon",mode:this.mode,automaticLengthMeasurementUtils:i});this.destroyed?o.destroy():(this._drawTool=o,this.view.addAndActivateTool(o),o.on("vertex-add",n=>{if(n.vertices.length===1){const{view:c}=this,_=n.vertices[0].vertexIndex,V=o.getVertexCoords();this.emit("vertex-add",new p(c,_,V)),n.operation!=="undo"&&n.operation!=="redo"||this.emit(n.operation,new p(c,_,V))}}),o.on("vertex-remove",n=>{if(n.vertices.length===1){const{view:c}=this,_=n.vertices[0].vertexIndex,V=o.getVertexCoords();this.emit("vertex-remove",new m(c,_,V)),n.operation!=="undo"&&n.operation!=="redo"||this.emit(n.operation,new m(c,_,V))}}),o.on("cursor-update",n=>{n.vertices.length===1&&this.emit("cursor-update",new v(this.view,n.vertices[0].vertexIndex,o.getVertexCoords()))}),o.on("complete",n=>{this.emit("draw-complete",new u(o.getVertexCoords())),this._removeDrawTool(),this.removeAllHandles()}))}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(e){const i=this._coordinateHelper.arrayToVector(e);this._isDuplicateOfLastVertex(i)||(this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(i))}_updateCursor(e=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const i=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);i==null||e||this._pushCursorVertex(i.vertex,()=>this.emit("cursor-update",new v(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new T(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return void this._drawTool.completeCreateOperation();if(this._activePointerId=null,this._popCursorVertex(),this._committedVertices.length<3)return;this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping();const e=new u(this.vertices);this.emit("draw-complete",e),e.defaultPrevented||this.removeAllHandles()}};r([a()],x.prototype,"_dragEnabled",null),r([a()],x.prototype,"_clickEnabled",null),r([a({type:$})],x.prototype,"mode",void 0),x=r([g("esri.views.draw.PolygonDrawAction")],x);const he=x;let O=class extends f{constructor(t){super(t),this._panEnabled=!1,this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1,this._drawTool=null,this.mode=Z}initialize(){this._addViewHandles(),this.view.type==="3d"&&this.addResolvingPromise(this._addDrawTool())}destroy(){this._removeDrawTool(),this.emit("destroy")}get _clickEnabled(){return this.mode==="click"||this.mode==="hybrid"}get _dragEnabled(){return this.mode==="freehand"||this.mode==="hybrid"}undo(){this._drawTool?this._drawTool.undo():(super.undo(),this.notifyChange("vertices"))}redo(){this._drawTool?this._drawTool.redo():(super.redo(),this.notifyChange("vertices"))}canUndo(){return this._drawTool?.canUndo()??super.canUndo()}canRedo(){return this._drawTool?.canRedo()??super.canRedo()}complete(){this._completeDrawing()}_addViewHandles(){this._addViewHandles2DOnly(),this.addHandles([this.view.on("key-down",t=>{const{key:e,repeat:i}=t;e!==d.vertexAdd||i?e!==d.complete||i?e!==d.undo||this.interactiveUndoDisabled||i?e!==d.redo||this.interactiveUndoDisabled||i||(t.stopPropagation(),this.redo()):(t.stopPropagation(),this.undo()):(t.stopPropagation(),this._drawCompleteHandler(t)):(t.stopPropagation(),this._handleVertexAddKey(t))},s.TOOL)])}_addViewHandles2DOnly(){this.view.type==="2d"&&(this.addHandles([this.view.on("click",t=>{t.stopPropagation()},s.TOOL),this.view.on("pointer-down",t=>{this._shouldHandlePointerEvent(t)&&!this._panEnabled&&(this._abortSnapping(),this._activePointerId=t.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=h(t),t.pointerType==="touch"&&this._updateCursor())},s.TOOL),this.view.on("pointer-move",t=>{this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._abortSnapping(),this._cursorScreenPoint=h(t),t.pointerType!=="touch"&&this._updateCursor()},s.TOOL),this.view.on("pointer-drag",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._cursorScreenPoint=h(t),this._dragEnabled&&!this._panEnabled?this._vertexAddHandler(t):this._addVertexOnPointerUp=!1)},s.TOOL),this.view.on("pointer-up",t=>{if(this._shouldHandlePointerEvent(t))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp){if(!this._clickEnabled)return this.vertices.length===1&&this.vertices.pop(),void this._drawCompleteHandler(t);this._vertexAddHandler(t)}else{const e=t.pointerType==="touch";this._updateCursor(e)}},s.TOOL),this.view.on("drag",t=>{this._dragEnabled&&this._activePointerId!=null&&!this._panEnabled&&t.stopPropagation()},s.TOOL),this.view.on("drag",["Shift"],t=>{t.stopPropagation()},s.TOOL),this.view.on("double-click",t=>{t.stopPropagation(),this._drawCompleteHandler(t)},s.TOOL),this.view.on("double-click",["Control"],t=>{t.stopPropagation(),this._drawCompleteHandler(t)},s.TOOL),this.view.on("key-down",t=>{const{key:e,repeat:i}=t;e!==d.pan||i||(t.stopPropagation(),this._panEnabled=!0)},s.TOOL),this.view.on("key-up",t=>{t.key===d.pan&&(t.stopPropagation(),this._panEnabled=!1)},s.TOOL)]),this._addUndoRedoHandles())}_handleVertexAddKey(t){this._drawTool?this._drawTool.drawOperation.commitStagedVertex():this._cursorScreenPoint&&(this._abortSnapping(),this._vertexAddHandler(t))}_addUndoRedoHandles(){this.addHandles([this._editGeometryOperations.on("vertex-remove",t=>{if(this.notifyChange("vertices"),t.operation==="undo"){const e=[...this._committedVertices];this._stagedVertex!=null&&e.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new m(this.view,t.vertices[0].index,e))}}),this._editGeometryOperations.on("vertex-add",t=>{if(this.notifyChange("vertices"),t.operation==="apply"){const e=this._committedVertices.length-1,i=new p(this.view,e,this.vertices);this.emit("vertex-add",i),i.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(t.operation==="redo"){const e=[...this._committedVertices];this._stagedVertex!=null&&e.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new p(this.view,t.vertices[0].index,e))}})])}async _addDrawTool(){const[{DrawTool:t},e]=await Promise.all([b(()=>import("./DrawTool-DorrJd-Y.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11])),S()]),i=new t({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"polyline",mode:this.mode,automaticLengthMeasurementUtils:e});this.destroyed?i.destroy():(this._drawTool=i,this.view.addAndActivateTool(i),this.addHandles([i.on("vertex-add",o=>{if(o.vertices.length!==1)return;const{view:n}=this,c=o.vertices[0].vertexIndex,_=i.getVertexCoords();this.emit("vertex-add",new p(n,c,_)),o.operation!=="undo"&&o.operation!=="redo"||this.emit(o.operation,new p(n,c,_))}),i.on("vertex-remove",o=>{if(o.vertices.length!==1)return;const{view:n}=this,c=o.vertices[0].vertexIndex,_=i.getVertexCoords();this.emit("vertex-remove",new m(n,c,_)),o.operation!=="undo"&&o.operation!=="redo"||this.emit(o.operation,new m(n,c,_))}),i.on("cursor-update",o=>{o.vertices.length===1&&this.emit("cursor-update",new v(this.view,o.vertices[0].vertexIndex,i.getVertexCoords()))}),i.on("complete",o=>{this.emit("draw-complete",new u(i.getVertexCoords())),this._removeDrawTool(),this.removeAllHandles()})]))}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(t){const e=this._coordinateHelper.arrayToVector(t);this._isDuplicateOfLastVertex(e)||(this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(e))}_updateCursor(t=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const e=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);e==null||t||this._pushCursorVertex(e.vertex,()=>this.emit("cursor-update",new v(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new T(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return void this._drawTool.completeCreateOperation();if(this._activePointerId=null,this._popCursorVertex(),this._committedVertices.length<2)return;this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping();const t=new u(this.vertices);this.emit("draw-complete",t),t.defaultPrevented||this.removeAllHandles()}};r([a()],O.prototype,"_clickEnabled",null),r([a()],O.prototype,"_dragEnabled",null),r([a({type:$})],O.prototype,"mode",void 0),O=r([g("esri.views.draw.PolylineDrawAction")],O);const le=O,pe=["freehand","click"];let H=class extends f{constructor(t){super(t),this._isDragging=!1,this._panEnabled=!1,this._addVertexOnPointerUp=!1,this._drawTool=null,this.viewAlignedCoordinateSystem=null,this.mode="freehand"}initialize(){this.view.type==="2d"?this._addViewHandles():this.addResolvingPromise(this._addDrawTool())}destroy(){this._removeDrawTool(),this.emit("destroy")}complete(){this._completeDrawing()}_getGeometryZValue(){return this.hasZ&&this.vertices.length>0?this.vertices[0][2]:this.defaultZ}_addViewHandles(){this.mode==="click"?this.addHandles(this._getClickModeViewHandles()):this.addHandles(this._getDragModeViewHandles())}_getDragModeViewHandles(){return[this.view.on("immediate-click",t=>{t.stopPropagation(),t.mapPoint&&!this._panEnabled&&this.getCoordsFromScreenPoint(h(t))!=null&&(this._vertexAddHandler(t),this._drawCompleteHandler(t))},s.TOOL),this.view.on("pointer-down",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._panEnabled||(this._resetGeometry(),this._addVertexOnPointerUp=!0,this._cursorScreenPoint=h(t),this._activePointerId=t.pointerId,this._vertexAddHandler(t),this._isDragging=!1,t.pointerType==="touch"&&this._updateCursor()))},s.TOOL),this.view.on("pointer-move",t=>{this._abortSnapping(),this._activePointerId==null&&t.pointerType!=="touch"&&(this._cursorScreenPoint=h(t),this._updateCursor())},s.TOOL),this.view.on("pointer-drag",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._isDragging=!0,this._cursorScreenPoint=h(t),this._updateCursor())},s.TOOL),this.view.on("pointer-up",t=>{this._shouldHandlePointerEvent(t)&&this._addVertexOnPointerUp&&(this._abortSnapping(),this._activePointerId=null,this._isDragging&&this._vertexAddHandler(t),this._committedVertices.length===2&&this._drawCompleteHandler(t),this._isDragging=!1)},s.TOOL),this.view.on("key-down",t=>{t.key===d.complete&&this._cursorScreenPoint?(this._abortSnapping(),this._vertexAddHandler(t),this._drawCompleteHandler(t)):t.key===d.pan&&(this._panEnabled=!0)},s.TOOL),this.view.on("key-up",t=>{t.key===d.pan&&(this._panEnabled=!1)},s.TOOL),this.view.on("drag",t=>{this._activePointerId!=null&&t.stopPropagation()},s.TOOL),this.view.on("drag",["Shift"],t=>{t.stopPropagation()},s.TOOL)]}_getClickModeViewHandles(){return[this.view.on("pointer-down",t=>{this._abortSnapping(),this._cursorScreenPoint=h(t),this._activePointerId=t.pointerId,this._isDragging=!1,t.pointerType==="touch"&&this._updateCursor()},s.TOOL),this.view.on("pointer-move",t=>{this._abortSnapping(),this._cursorScreenPoint=h(t),this._activePointerId==null&&t.pointerType!=="touch"&&this._updateCursor()},s.TOOL),this.view.on("pointer-drag",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._isDragging=!0)},s.TOOL),this.view.on("pointer-up",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._activePointerId=null,t.stopPropagation(),this._isDragging||this._vertexAddHandler(t),this.vertices.length!==2||this._isDragging||this._drawCompleteHandler(t),this._isDragging=!1)},s.TOOL),this.view.on("key-down",t=>{t.key===d.vertexAdd&&this._cursorScreenPoint&&(this._vertexAddHandler(t),this.vertices.length===2&&this._drawCompleteHandler(t)),t.key===d.complete&&this._cursorScreenPoint&&this.vertices.length===2&&(this._vertexAddHandler(t),this._drawCompleteHandler(t))},s.TOOL)]}async _addDrawTool(){const[{DrawTool:t},e]=await Promise.all([b(()=>import("./DrawTool-DorrJd-Y.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11])),S()]),i=new t({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"segment",mode:this.mode,automaticLengthMeasurementUtils:e});this.destroyed?i.destroy():(this._drawTool=i,this.view.addAndActivateTool(i),this.addHandles([i.on("vertex-add",o=>{o.vertices.length===1&&this.emit("vertex-add",new p(this.view,o.vertices[0].vertexIndex,i.getVertexCoords()))}),i.on("cursor-update",o=>{o.vertices.length===1&&this.emit("cursor-update",new v(this.view,o.vertices[0].vertexIndex,i.getVertexCoords()))}),i.on("complete",o=>{this.emit("draw-complete",new u(i.getVertexCoords())),this._removeDrawTool()}),this.view.on("key-down",o=>{o.key!==d.vertexAdd||o.repeat||this.mode!=="click"?o.key!==d.complete||o.repeat||i.completeCreateOperation():i.drawOperation.numCommittedVertices>0?i.completeCreateOperation():i.drawOperation.commitStagedVertex()},s.TOOL)]))}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(t){const e=this._coordinateHelper.arrayToVector(t);if(this._isDuplicateOfLastVertex(e))return;this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(e),this._committedVertices.length===1&&(this.viewAlignedCoordinateSystem=oe(this.view,this._committedVertices[0]));const i=this._committedVertices.length-1,o=new p(this.view,i,this.vertices);this.emit("vertex-add",o)}_updateCursor(){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const t=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);t!=null&&this._pushCursorVertex(t.vertex,()=>this.emit("cursor-update",new v(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new T(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return this._drawTool.completeCreateOperation(),void this.removeAllHandles();if(this._activePointerId=null,this._popCursorVertex(),this._cursorScreenPoint=null,this._isDragging=!1,this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping(),this.vertices.length<1)return;const t=new u(this.vertices);this.emit("draw-complete",t),t.defaultPrevented||this.removeAllHandles()}_resetGeometry(){this._editGeometryOperations.destroy(),this._editGeometryOperations=new G(new M("polygon",this._coordinateHelper),C.Local),this._activeComponent=new R(this._coordinateHelper.spatialReference,C.Local),this._editGeometryOperations.data.components.push(this._activeComponent)}};r([a({type:pe})],H.prototype,"mode",void 0),H=r([g("esri.views.draw.SegmentDrawAction")],H);const ce=H;let P=class extends k{constructor(){super(...arguments),this.activeAction=null,this.type="draw",this.view=null}destroy(){this.activeAction&&(this.activeAction.destroy(),this.activeAction=null)}create(e,i){this.reset();const o={view:this.view,...i};switch(e){case"point":o.editGeometryType="point",this.activeAction=new de(o);break;case"polyline":o.editGeometryType="polyline",this.activeAction=new le(o);break;case"multipoint":o.editGeometryType="polygon",this.activeAction=new ae(o);break;case"polygon":o.editGeometryType="polygon",this.activeAction=new he(o);break;case"rectangle":case"circle":case"ellipse":case"triangle":o.editGeometryType="polygon",this.activeAction=new ce(o)}return this.activeAction}complete(){this.activeAction&&this.activeAction.complete(),this.activeAction=null}reset(){this.activeAction&&this.activeAction.destroy(),this.activeAction=null}};r([a()],P.prototype,"activeAction",void 0),r([a({readOnly:!0})],P.prototype,"type",void 0),r([a()],P.prototype,"view",void 0),P=r([g("esri.views.draw.Draw")],P);const xe=P;let w=class extends k{constructor(t){super(t),this.tool=null,this._loggedUnsupportedErrorOnce=!1,t?.visible!=null&&(this.visible=t.visible)}initialize(){this.addHandles(Q(()=>({ready:this.view!=null&&this.view.ready,supported:this.supported}),({ready:t,supported:e})=>{!t||e||this._loggedUnsupportedErrorOnce||(this.logError(this.unsupportedErrorMessage),this._loggedUnsupportedErrorOnce=!0)},q))}destroy(){this.removeTool(),this.view=null}get active(){return this.tool!=null&&this.tool.active}get disabled(){return this.view==null||!this.view.ready||!this.supported}get supported(){return this.view==null||this.view.type===this.supportedViewType}get view(){return this._get("view")}set view(t){if(t===this.view)return;this.removeTool(),this._set("view",t);const e="tools";this.removeHandles(e),t!=null&&this.addHandles(t.tools.on("after-remove",i=>{i.item===this.tool&&this._set("tool",null)}),e)}set visible(t){this._set("visible",t),this.tool!=null&&(this.tool.visible=t)}createTool(t={interactive:!1}){if(this.removeTool(),this.view==null||!this.view.ready||!this.supported)return;const e=this.constructTool();e.created?(this._set("tool",e),this.view.tools.add(e)):t.interactive?(this._set("tool",e),this.view.addAndActivateTool(e),J(()=>e.created,()=>{e.active&&this.view!=null&&(this.view.activeTool=null)},{initial:!0,once:!0})):e.destroy()}removeTool(){const t=this.tool;if(t==null)return;const e=this.view?.tools;e!=null?e.remove(t):t.destroy(),this._set("tool",null)}logError(...t){W.getLogger(this).error(...t)}};r([a({constructOnly:!0})],w.prototype,"tool",void 0),r([a()],w.prototype,"active",null),r([a()],w.prototype,"disabled",null),r([a()],w.prototype,"supported",null),r([a({value:null})],w.prototype,"view",null),r([a({type:Boolean,value:!0})],w.prototype,"visible",null),w=r([g("esri.widgets.support.InteractiveToolViewModel")],w);export{xe as l,w as p};
